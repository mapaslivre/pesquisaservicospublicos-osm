<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Pesquisas de Serviços Públicos - OSM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Axios para requisições -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- Turf.js para geoprocessamento -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>

  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      font-family: Arial, sans-serif;
    }
    #map {
      flex: 1;
    }
    #sidebar {
      width: 300px;
      background: #f9f9f9;
      border-left: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    h2 {
      font-size: 18px;
      margin-top: 0;
    }
    select, button, input {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h2>Serviços Públicos</h2>
    <input type="text" id="cidade" placeholder="Digite uma cidade">
    <button id="btnLocalizar">Localizar Cidade</button>
    <select id="tipoServico">
      <option value="school">Escolas</option>
      <option value="hospital">Hospitais</option>
      <option value="clinic">Postos de Saúde</option>
      <option value="grave_yard">Cemitérios</option>
      <option value="park">Praças</option>
      <option value="townhall">Prefeituras</option>
      <option value="public_building">Câmaras de Vereadores</option>
      <option value="police">Polícia</option>
      <option value="fire_station">Bombeiros</option>
      <option value="ambulance_station">SAMU</option>
      <option value="government">Secretarias</option>
    </select>
    <button id="btnPesquisar">Pesquisar</button>
    <button id="btnDownload">Baixar GeoJSON</button>
    <h3>Contagem por Bairro</h3>
    <canvas id="chart"></canvas>
  </div>

  <script>
    // Inicializa o mapa
    const map = L.map('map').setView([-15.78, -47.93], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap colaboradores'
    }).addTo(map);

    // Cluster para marcadores
    const markers = L.markerClusterGroup().addTo(map);

    // Dados da última consulta
    let lastGeoJSON = null;

    // Localizar cidade com Nominatim
    document.getElementById('btnLocalizar').addEventListener('click', async () => {
      const cidade = document.getElementById('cidade').value;
      if (!cidade) return alert("Digite o nome de uma cidade.");
      try {
        const resp = await axios.get(`https://nominatim.openstreetmap.org/search`, {
          params: {
            q: cidade,
            format: "json",
            limit: 1
          }
        });
        if (resp.data.length > 0) {
          const { lat, lon } = resp.data[0];
          map.setView([lat, lon], 13);
        } else {
          alert("Cidade não encontrada.");
        }
      } catch (err) {
        alert("Erro ao buscar cidade.");
      }
    });

    // Pesquisa serviços públicos via Overpass
    document.getElementById('btnPesquisar').addEventListener('click', async () => {
      const tipo = document.getElementById('tipoServico').value;
      const bounds = map.getBounds();
      const query = `
        [out:json][timeout:25];
        (
          node["amenity"="${tipo}"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
          way["amenity"="${tipo}"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
          relation["amenity"="${tipo}"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
        );
        out body;
        >;
        out skel qt;
      `;

      try {
        const resp = await axios.post("https://overpass-api.de/api/interpreter", query, {
          headers: { "Content-Type": "text/plain" }
        });

        const data = resp.data;
        const geojson = osmtogeojson(data);

        markers.clearLayers();
        const layer = L.geoJSON(geojson, {
          onEachFeature: (feature, layer) => {
            let props = feature.properties;
            let popup = `<b>${props.tags.name || "Sem nome"}</b><br/>${tipo}`;
            layer.bindPopup(popup);
          }
        });
        markers.addLayer(layer);

        lastGeoJSON = geojson;
        atualizarGrafico(geojson);
      } catch (err) {
        alert("Erro na consulta Overpass.");
        console.error(err);
      }
    });

    // Baixar resultado em GeoJSON
    document.getElementById('btnDownload').addEventListener('click', () => {
      if (!lastGeoJSON) return alert("Nenhum resultado para baixar.");
      const blob = new Blob([JSON.stringify(lastGeoJSON)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "servicos_publicos.geojson";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Atualizar gráfico com contagem simples (por "bairro" = tag addr:suburb se existir)
    function atualizarGrafico(geojson) {
      let counts = {};
      geojson.features.forEach(f => {
        let bairro = f.properties.tags["addr:suburb"] || "Desconhecido";
        counts[bairro] = (counts[bairro] || 0) + 1;
      });

      let labels = Object.keys(counts);
      let values = Object.values(counts);

      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade',
            data: values
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    // Conversor OSM → GeoJSON (osmtogeojson)
    function osmtogeojson(data) {
      // Biblioteca mínima incluída aqui (adaptada)
      return osm2geojson(data);
    }

    // Pequena versão inline do osm2geojson
    // (mais leve que importar via <script>)
    function osm2geojson(json) {
      let geojson = { type: "FeatureCollection", features: [] };
      if (!json.elements) return geojson;

      json.elements.forEach(el => {
        if (el.type === "node") {
          geojson.features.push({
            type: "Feature",
            geometry: { type: "Point", coordinates: [el.lon, el.lat] },
            properties: { id: el.id, tags: el.tags || {} }
          });
        }
        if (el.type === "way" && el.nodes) {
          let coords = el.nodes.map(nid => {
            let node = json.elements.find(e => e.type === "node" && e.id === nid);
            return node ? [node.lon, node.lat] : null;
          }).filter(Boolean);
          geojson.features.push({
            type: "Feature",
            geometry: { type: "Polygon", coordinates: [coords] },
            properties: { id: el.id, tags: el.tags || {} }
          });
        }
      });
      return geojson;
    }
  </script>
</body>
</html>

